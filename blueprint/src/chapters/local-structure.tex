\chapter{Local structure}

\section{Preliminaries}

The following definitions are already formalized in Mathlib.

\begin{definition}[Extremally disconnected space]
    \label{def:extremally-disconnected}
    \lean{ExtremallyDisconnected}
    \mathlibok

    A topological space \(X\) is \emph{extremally disconnected} if the closure of every open subset is open.
\end{definition}

\begin{definition} [Stone-Čech compactification]
    \label{def:stone-cech-compactification}
    \lean{StoneCech}
    \mathlibok

    Let \(X\) be a topological space. The \emph{Stone-Čech compactification} of \(X\) is the
    profinite space \(\beta(X)\) such that
    \begin{enumerate}
        \item \(X\) is dense in \(\beta(X)\);
        \item every continuous map \(f: X \to Y\) to a compact Hausdorff space \(Y\)
            extends uniquely to a continuous map \(\beta(f): \beta(X) \to Y\).
    \end{enumerate}
    We denote the Stone-Čech compactification of \(X\) by \(\beta(X)\).
\end{definition}

\begin{theorem}
    Let \(X\) be a topological space. Then the Stone-Čech compactification \(\beta(X)\) is extremally disconnected.
    \label{thm:stone-cech-extremally-disconnected}
    \uses{def:extremally-disconnected, def:stone-cech-compactification}
    \lean{StoneCech.projective}
    \mathlibok
\end{theorem}

\begin{proof}
    Omitted.
\end{proof}

\section{Henselization}

1. Ofer Gabber \(K\)-theory of Henselian local rings and Henselian pairs.

2. \url{https://stacks.math.columbia.edu/tag/0EM7}

3. \url{https://arxiv.org/pdf/2112.13552} If \((A,I)\) is a Zariski pair (contained in Jacobson ideal, the only open set containing \(V(I)\) is \(\Spec A\), then the Henselization is faithfully flay over \(A\). The only input should be Tag 00HR A flat local ring homomorphism of local rings is faithfully flat.

Unify the definition of 2.2.10 with the definition of Henselization in Gabber's paper.

\begin{definition}[Henselian pairs, ]
    \label{def:henselian-pair}

    TBA
\end{definition}

\begin{definition}[(Relative) Henselization, {\cite[Definition 2.2.1(ii)]{proetale}}]
    \label{def:henselization}

    TBA

\end{definition}

\begin{theorem}
    \label{thm:henselization-is-henselian}
    \uses{def:henselization,def:henselian-pair}
    TBA

\end{theorem}

\begin{lemma}[{\cite[Lemma 2.2.12]{proetale}}]
    \label{lem:henselization-fully-faithful}
    \uses{def:henselization}

    For surjective maps $A \to A/I$, the functor $\Hens_A(-)$ is fully faithful, so $\Hens_A(-) \otimes_A A/I \simeq \mathrm{id}$ as functors on $\mathrm{Ind}(\et{(A/I)})$.
\end{lemma}

\begin{lemma}[{\cite[Lemma 2.2.13]{proetale}}]

\section{Weakly étale algebras}

\begin{definition}[Ind-(Zariski localizations), {\cite[Definition 2.2.1(iv)]{proetale}}]
    \label{def:ind-zariski-localization}

    An $R$-algebra $S$ is called a \textit{Zariski localization} if $S \simeq \prod_{i=1}^n R[f_i^{-1}]$ for some $f_1,\dots,f_n \in R$. An \textit{ind-(Zariski localization)} is a filtered colimit of Zariski localizations. A ring homomorphism $f : R \to S$ is called a \textit{Zariski localization} (resp. \emph{ind-(Zariski localization)}) if $S$ is Zariski localization (resp. ind-(Zariski localization)) as an $R$-algebra via $f$.
\end{definition}

\begin{definition}[Weakly étale algebras, {\cite[Definition 2.3.1]{proetale}}]
    An $R$-algebra $S$ is \emph{weakly étale} if $S$ is flat over $R$ and
    $S$ is flat over $S \otimes_{R} S$. We say a ring homomorphism
    $R \to S$ is \emph{weakly étale} if $S$ is weakly étale as an $R$-algebra via $f$.
    \label{def:weakly-etale-algebra}
\end{definition}

\begin{definition}[Ind-étale algebras, {\cite[\href{https://stacks.math.columbia.edu/tag/097I}{Tag 097I}]{stacks-project}}]
    An $R$-algebra $S$ is \emph{ind-étale} if it is a filtered colimit of étale $R$-algebras.
    We say a ring homomorphism $R \to S$ is \emph{ind-étale} if $S$ is ind-étale as an $R$-algebra via $f$.
    \label{def:ind-etale-algebra}
\end{definition}

\begin{lemma}
    \label{lem:ind-etale-flat-of-ind-Zariski}
    \uses{def:ind-zariski-localization, def:ind-etale-algebra}

    If \(S\) is an ind-(Zariski localization) \(R\)-algebra, then \(S\)ind-étale and flat over \(R\).
\end{lemma}

The following relation between weakly étale algebra and ind-étale algebra is the main result of this section.
\begin{theorem}[{\cite[Theorem 2.3.4]{proetale}}]
Let $f: A \to B$ be weakly étale. Then there exists a faithfully flat ind-étale morphism $g: B \to C$ such that $g \circ f: A \to C$ is ind-étale.
    \label{thm:weakly-etale-ind-etale}
\end{theorem}

Check whether theorem 5.4.2 can be refactored to avoid use the above theorem by directly mimicking the proof of topological invariance of étale sites for weakly étale.

Remove 5.4.1



The local version of Theorem 2.3.4 follows from the following result of Olivier, \cite{Oli72}:

\begin{theorem}[{\cite[Theorem 2.3.5]{proetale}}]
Let $A$ be a strictly henselian local ring, and let $B$ be a weakly étale local $A$-algebra. Then $f: A \to B$ is an isomorphism.
    \label{thm:weakly-etale-local}
\end{theorem}


\section{w-local spaces}

Goal: For every spectral space \(X\), construct the pro-(open cover) \(X^Z \to X\) that admits no further non-split open covers.

\begin{definition}[w-local spaces, {\cite[Definition 2.1.1]{proetale}}]
    \label{def:w-local-space}
    A topological space \(X\) is \emph{w-local} if it satisfies:
    \begin{enumerate}
        \item \(X\) is spectral;
        \item All open covers split, i.e., for every open cover \(\{U_i\}_{i \in I}\) of \(X\), the map \(\coprod_{i \in I} U_i \to X\) has a section;
        \item The subspace \(X^c\) of closed points is closed.
    \end{enumerate}
\end{definition}

\begin{definition}[w-local morphisms, {\cite[Definition 2.1.1]{proetale}}]
    Let \(X\) and \(Y\) be w-local spaces. A morphism \(f: X \to Y\) is \emph{w-local} if it is spectral and the image of closed points \(f(X^c) \subseteq Y^c\).
    \label{def:w-local-morphism}
    \uses{def:w-local-space}
\end{definition}

\begin{definition}
    \label{def:w-local-space-category}
    \uses{def:w-local-space, def:w-local-morphism}

    Let \(S\) denote the category of spectral spaces. The category of w-local spaces is denoted by \(\S^{wl}\). The objects are w-local spaces, and the morphisms are w-local morphisms. The inclusion functor is denoted by \(i: \S^{wl} \to \S\).
\end{definition}

\begin{lemma}[{\cite[Lemma 2.1.9]{proetale}}]
    \label{lem:w-local-space-preserves-limits}
    \uses{def:w-local-space-category}

    The category $\mathcal{S}^{wl}$ admits all small limits, and the inclusion $i : \mathcal{S}^{wl} \to \mathcal{S}$ preserves these limits.
\end{lemma}

% TBA: S: category of spectral spaces, i : \(\S^{wl}\) is the full subcategory of \(\S\) consisting of w-local spaces.

\begin{lemma}[{\cite[Lemma 2.1.4, second part]{proetale}}]
    \label{lem:w-local-space-connected-components}
    \uses{def:w-local-space}

    Let $X$ be a w-local spectral space. The composition $X^c \to X \to \pi_0(X)$ is a homeomorphism.
\end{lemma}

\begin{definition}[{\cite[Lemma 2.1.10]{proetale}}]
    \label{def:w-localization-space}
    \uses{def:w-local-space, def:w-local-space-category}
    The inclusion $i : \mathcal{S}^{wl} \to \mathcal{S}$ admits a right adjoint $X \mapsto X^Z$. The counit $X^Z \to X$ is a pro-(open cover) for all $X$, and the composite $(X^Z)^c \to X$ is a homeomorphism for the constructible topology on $X$.
\end{definition}

\section{w-local rings}

\begin{definition}[w-local rings, {\cite[Definition 2.2.1(i)]{proetale}}]
    A ring \(A\) is \emph{w-local} if Spec(A) is w-local.
    \label{def:w-local-ring}
    \uses{def:w-local-space}
\end{definition}

\begin{definition}[w-local ring maps, {\cite[Definition 2.2.1(iii)]{proetale}}]
    A ring map \(f: A \to B\) between w-local rings is \emph{w-local} if the induced map of w-local spaces \(\Spec(f) : \Spec(B) \to \Spec(A)\) is w-local.
    \label{def:w-local-ring-map}
    \uses{def:w-local-ring, def:w-local-space, def:w-local-morphism}
\end{definition}

\begin{definition}[{\cite[Lemma 2.2.4]{proetale}}]
    \label{def:w-localization-ring}
    \uses{def:w-localization-space}
    The inclusion of the category of w-local rings and maps inside all rings admits a left adjoint $A \mapsto A^Z$. The unit $A \to A^Z$ is a faithfully flat ind-(Zariski localization), and $\Spec(A)^Z = \Spec(A^Z)$ over $\Spec(A)$.
\end{definition}

\begin{definition}[w-strictly local rings, {\cite[Definition 2.2.1(ii)]{proetale}}]
    A ring \(A\) is \emph{w-strictly local} if \(A\) is w-local, and every faithfully flat \'etale map \(A \to B\) has a section.
    \label{def:w-strictly-local-ring}
    \uses{def:w-local-ring}
\end{definition}

\begin{lemma}[{\cite[Lemma 2.2.9]{proetale}}]
    \label{lem:w-strictly-local-closed-points}
    \uses{def:w-strictly-local-ring, def:w-local-ring}

    A w-local ring $A$ is w-strictly local if and only if all local rings of $A$ at closed points are strictly henselian.
\end{lemma}

\begin{lemma}
    \label{lem:w-strictly-local-ind-Zariski-localization}
    \uses{def:w-strictly-local-ring, def:w-local-ring}
    If $A$ is w-strictly local, $B$ is an ind-Zariski localization of $A$, and $B$ is w-local, then $B$ is w-strictly local.
\end{lemma}

\begin{proof}
    \uses{lem:w-strictly-local-closed-points}

    TBA. Use \Cref{lem:w-strictly-local-closed-points}.
\end{proof}

\begin{definition}[Absolutly flat rings]
    A ring \(A\) is \emph{absolutely flat} if \(A\) is reduced with Krull dimension \(0\).
    \label{def:absolute-flat-ring}
\end{definition}

\begin{lemma}[{\cite[Lemma 2.2.3]{proetale}}]
    \label{lem:w-local-quotient-Jacobson-absolute-flat}
    \uses{def:w-local-ring, def:absolute-flat-ring}

    If \(A\) is w-local, then the Jacobson radical \(I_A\) cuts out \(\Spec(A)^c \to \Spec(A)\) with its reduced structure. The quotient \(A/I_A\) is an absolutely flat ring.
\end{lemma}

\begin{lemma}[{\cite[Lemma 2.2.7]{proetale}}]
    \label{lem:absolute-flat-exists-ind-etale-w-strictly-local}
    \uses{def:absolute-flat-ring, def:w-strictly-local-ring}

    For any absolutely flat ring $A$, there is an ind-étale faithfully flat map $A \to \overline{A}$ with $\overline{A}$ w-strictly local and absolutely flat. % For a map $A \to B$ of absolutely flat rings, we can choose such maps $A \to \overline{A}$ and $B \to \overline{B}$ together with a map $\overline{A} \to \overline{B}$ of $A$-algebras.
\end{lemma}

\begin{definition}[{\cite[Lemma 2.2.8]{proetale}}]%TODO: move this to a better place.
    \label{lem:decouple-topology-from-algebra}

    For any affine scheme $X$, the functor $Y \mapsto \pi_0(Y)$ from affine $X$-schemes \(\AffSch_{/X}\) to profinite $\pi_0(X)$-sets \(\ProFin_{/\pi_0(X)}\) has a fully faithful right adjoint $S \mapsto S \times_{\pi_0(X)} X$, the fibre product in the category of topological spaces ringed using the pullback of the structure sheaf on $X$. Moreover, the natural map $S \times_{\pi_0(X)} X \to X$ is a pro-(Zariski localisation) and pro-finite.
\end{definition}

\section{w-contractible rings}

\begin{definition}[w-contractible rings, {\cite[Definition 2.4.1]{proetale}}]
A ring \(A\) is \emph{w-contractible} if every faithfully flat ind-\'etale map \(A \to B\) has a section.
    \label{def:w-contractible-ring}
\end{definition}

\begin{lemma}[{\cite[Lemma 2.4.3]{proetale}}]
    \label{lem:w-contractible-henselian}
    \uses{def:w-contractible-ring, def:henselian-pair}

    Let $A$ be a ring henselian along an ideal $I$. Then $A$ is w-contractible if and only if $A/I$ is so.
\end{lemma}

\begin{lemma}[{\cite[Lemma 2.4.8]{proetale}}]
    \label{lem:w-strictly-local-pi0-extremally-disconnected}
    \uses{def:w-contractible-ring, def:w-strictly-local-ring}
    A w-strictly local ring $A$ is w-contractible if and only if $\pi_0(\operatorname{Spec}(A))$ is extremally disconnected.
\end{lemma}

The last theorem in this section used before \cite[Theorem 5.6.2]{proetale} is the following \Cref{thm:ind-etale-w-contractible-cover-exists}

\begin{lemma}[{\cite[Theorem 2.4.9]{proetale}}]
    For any ring $A$, there exists an ind-étale faithfully flat $A$-algebra $A_0$ with $A_0$ w-contractible.
    \label{thm:ind-etale-w-contractible-cover-exists}
    \uses{def:w-contractible-ring}
\end{lemma}

\begin{proof}
    \uses{thm:stone-cech-extremally-disconnected,lem:w-local-quotient-Jacobson-absolute-flat,lem:absolute-flat-exists-ind-etale-w-strictly-local,lem:w-local-space-connected-components,lem:decouple-topology-from-algebra,lem:w-local-space-preserves-limits,lem:w-strictly-local-ind-Zariski-localization,
    lem:w-strictly-local-pi0-extremally-disconnected,lem:ind-etale-flat-of-ind-Zariski,
    lem:henselization-fully-faithful,lem:w-contractible-henselian,def:w-localization-ring}
    
    We construct $A_0$ in two steps: first building a w-strictly local cover of $A^Z/I_{A^Z}$, then lifting it to $A$.

    \begin{enumerate}
        \item \textbf{Construction of w-strictly local cover of $A^Z/I_{A^Z}$:} 
        We construct an ind-étale faithfully flat $A^Z/I_{A^Z}$-algebra $A_0'$ that is w-strictly local with extremally disconnected profinite set of connected components.

        \begin{enumerate}
            \item Since $A^Z/I_{A^Z}$ is absolutely flat (\Cref{lem:w-local-quotient-Jacobson-absolute-flat}), \Cref{lem:absolute-flat-exists-ind-etale-w-strictly-local} gives an ind-étale faithfully flat $A^Z/I_{A^Z}$-algebra $\overline{A}$ that is w-strictly local and absolutely flat.

            \item Let $X = \Spec \overline{A}$. By \Cref{lem:w-local-space-connected-components}, we have $X^c \simeq \pi_0(X)$. Take $Y_0 = \beta(X^c)$, the Stone-Čech compactification of $X^c$, which is extremally disconnected (\Cref{thm:stone-cech-extremally-disconnected}).

            \item Applying the functor $S \mapsto S \times_{\pi_0(X)} X$ from $\ProFin_{/\pi_0(X)}$ to $\AffSch_{/X}$ (\Cref{lem:decouple-topology-from-algebra}) to $Y_0$ yields an ind-(Zariski localization) map $f: \overline{A} \to A_0'$ with $(\Spec A_0')^c \cong Y_0$. By \Cref{lem:w-local-space-preserves-limits} for preservation of w-locality under limits with w-local maps, this construction is w-local. By \Cref{lem:w-strictly-local-ind-Zariski-localization}, since $A_0'$ is an ind-(Zariski localization) of a w-strictly local ring $\overline{A}$, $A_0'$ is also w-strictly local.

            The map \(\bar{A} \to A_0'\) is ind-étale and faithfully flat by \Cref{lem:ind-etale-flat-of-ind-Zariski} and the surjectivity on \(\Spec \bar{A}\).

            \item Since both maps \(A^Z/I_{A^Z} \to \bar{A} \to A_0'\) are ind-étale and faithfully flat, the composition $A^Z/I_{A^Z} \to A_0'$ is ind-étale faithfully flat.
        \end{enumerate}
        
        By \Cref{lem:w-strictly-local-pi0-extremally-disconnected}, $A_0'$ is w-contractible.

        \item \textbf{Lifting to $A$:} 
        Define $A_0 = \operatorname{Hens}_{A^Z}(A_0')$, the Henselization of $A_0'$ relative to $A^Z$.
        
        \begin{enumerate}
            \item By \Cref{lem:henselization-fully-faithful}, we have $A_0 \otimes_{A^Z} (A^Z/I_{A^Z}) \cong A_0'$. Since $A_0$ is Henselian along $I_{A^Z}A_0$, \Cref{lem:w-contractible-henselian} implies $A_0$ is w-contractible as $A_0'$ is w-contractible.

            \item The map $A \to A_0$ is faithfully flat and ind-étale because:
            \begin{itemize}
                \item $A \to A^Z$ is ind-étale faithfully flat (\Cref{def:w-localization-ring});
                \item $A^Z \to A_0$ is ind-étale (as a colimit of ind-étale maps) and faithfully flat {\red(quotient by Jacobson \(I^Z\) leaves maximal ideals unchanged. faithfully flat can be checked locally at maximal ideal of \(A^Z\). Remains to show (relative) Henselization of f.f. local ring hom is faithfully flat, and Henselization repect localization. Should develop a whole section of Henselization...)}
            \end{itemize}
        \end{enumerate}
\end{enumerate}


\end{proof}

